{
  "nodes": [
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"error\": true,\n  \"message\": \"Thông tin không hợp lệ\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        16,
        -192
      ],
      "id": "2cc21f20-c69a-4eaf-b5df-5b074bc8f9bd",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [
        -192,
        -192
      ],
      "id": "8b30f3f3-5b02-415b-9d51-1cdada5ee7ca",
      "name": "Error Trigger"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1KYVqHXbH1cnVG_rrqrA4-9ny1GFJx1JfW5uj67FpMiM",
          "mode": "list",
          "cachedResultName": "n8n-test",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1KYVqHXbH1cnVG_rrqrA4-9ny1GFJx1JfW5uj67FpMiM/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Trang tính1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1KYVqHXbH1cnVG_rrqrA4-9ny1GFJx1JfW5uj67FpMiM/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        128,
        192
      ],
      "id": "7d0821d7-a973-4bb1-82ec-e87635fd8927",
      "name": "Get row(s) in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "IJ7ketXaIkRYomuV",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chat-test",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -192,
        -48
      ],
      "id": "e63876c1-97de-4907-9df8-f075d22cc136",
      "name": "Webhook1",
      "webhookId": "52b9988d-9d1e-4c64-832b-6d505e3f3b1e"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer API KEY"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "HTTP-Referer",
              "value": "http://localhost"
            },
            {
              "name": "X-Title",
              "value": "n8n-chat"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1232,
        -32
      ],
      "id": "db9462c8-6d91-4ffa-96c4-c727037666b7",
      "name": "HTTP Request1",
      "retryOnFail": true
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "1KYVqHXbH1cnVG_rrqrA4-9ny1GFJx1JfW5uj67FpMiM",
          "mode": "list",
          "cachedResultName": "n8n-test",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1KYVqHXbH1cnVG_rrqrA4-9ny1GFJx1JfW5uj67FpMiM/edit?usp=drivesdk"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -48,
        192
      ],
      "id": "2e30c004-3dd9-4703-bb39-663796711889",
      "name": "Download file",
      "executeOnce": false,
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "lIrccTwk8CYMu9cc",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        560,
        -32
      ],
      "id": "c30bf0ea-c6be-4eda-8116-a3cd463232a5",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "const userMessage = $input.first().json.userMessage;\nconst filtered = $input.first().json.results;\nconst totalFound = $input.first().json.totalFound;\n\nconst payload = {\n  model: \"amazon/nova-2-lite-v1:free\",\n  messages: [\n    {\n      role: \"user\",\n      content: `\nNgười dùng hỏi: ${userMessage}\n\nDữ liệu được tìm thấy (${totalFound} kết quả, hiển thị tối đa 20):\n${JSON.stringify(filtered, null, 2)}\n\nBạn chỉ được trả lời dựa trên dữ liệu trên.\nNếu câu hỏi không khớp dữ liệu → trả lời \"Nội dung bạn gửi không hợp lệ\" hoặc \"Bạn cần phải hỏi nội dung về môn học \" ngay lập tức chứ không giải thích lí do hay gì cả.\n`\n    }\n  ]\n};\n\nreturn [{ json: payload }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1008,
        -32
      ],
      "id": "50a28d7f-a807-487e-8b07-32ff8cb33339",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "jsCode": "// JS1 — chỉ xử lý dữ liệu Google Sheet\n// Không đụng gì tới webhook\n\nconst items = $input.all();\n\n// Tự động convert từng row thành chuỗi để AI search sau\nconst processed = items.map(i => {\n  const row = i.json;\n  row._flatString = JSON.stringify(row).toLowerCase(); // thêm 1 trường phục vụ tìm kiếm\n  return { json: row };\n});\n\nreturn processed;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        192
      ],
      "id": "8bc340eb-1656-458b-b29b-a33edfec8038",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// Webhook = item đầu tiên\nconst userMessage = items[0].json.body.message.toLowerCase();\n\n// keyword\nconst keywordMatch = userMessage.match(/(nhập môn|cơ sở dữ liệu|lập trình|java|thực hành|đại số|giải tích)/gi);\nconst keyword = keywordMatch ? keywordMatch[0] : userMessage;\n\n// Sheet data (đã có _flatString từ JS1)\nconst sheetData = items.slice(1).map(i => i.json);\n\n// normalize\nfunction normalize(str) {\n  return str\n    .toLowerCase()\n    .normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\");\n}\n\n// lọc\nconst filtered = sheetData.filter(r =>\n  r._flatString && normalize(r._flatString).includes(normalize(keyword))\n);\n\nreturn [{\n  json: {\n    userMessage,\n    keyword,\n    results: filtered.slice(0, 20),\n    totalFound: filtered.length\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        784,
        -32
      ],
      "id": "41001970-39a0-4fcf-9b56-ca9a538ff978",
      "name": "Code in JavaScript2"
    }
  ],
  "connections": {
    "Error Trigger": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          },
          {
            "node": "Download file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download file": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "fe592d97760b30915ddde711d60e9a8ed69094554c2d8212edb422f325f8845c"
  }
}
